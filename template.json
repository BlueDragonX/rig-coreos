{
    "variables": {
        "version": "{{env `VERSION`}}",
        "artifacts": "{{env `ARTIFACTS`}}",
        "aws_account_id": "",
        "aws_access_key": "",
        "aws_secret_key": "",
        "aws_bucket": "",
        "aws_x509_cert": "",
        "aws_x509_key": ""
    },
    "builders": [{
        "name": "amazon",
        "type": "amazon-instance",
        "account_id": "{{user `aws_account_id`}}",
        "access_key": "{{user `aws_access_key`}}",
        "secret_key": "{{user `aws_secret_key`}}",
        "x509_cert_path": "{{user `aws_x509_cert`}}",
        "x509_key_path": "{{user `aws_x509_key`}}",
        "x509_upload_path": "/tmp",
        "ami_name": "CoreOS {{user `version`}}",
        "s3_bucket": "{{user `aws_bucket`}}/coreos/{{user `version`}}",
        "region": "us-east-1",
        "ami_regions": ["us-west-1", "us-west-2"],
        "source_ami": "ami-6b726502",
        "instance_type": "m1.small",
        "ssh_username": "ec2-user",
        "ssh_timeout": "5m",
        "bundle_prefix": "coreos",
        "bundle_vol_command": "ec2-bundle-image -i /tmp/coreos.bin -p coreos -d \"{{.Destination}}\" --arch x86_64 --kernel \"aki-919dcaf8\" --block-device-mapping ami=sda -u \"{{.AccountId}}\" -c \"{{.CertPath}}\" -k \"{{.KeyPath}}\"",
        "bundle_upload_command": "ec2-upload-bundle -b \"{{.BucketName}}\" -m \"{{.ManifestPath}}\" -a \"{{.AccessKey}}\" -s \"{{.SecretKey}}\""
    }, {
        "name": "virtualbox",
        "type": "virtualbox-iso",
        "vm_name": "coreos-{{user `version`}}",
        "guest_os_type": "Linux26_64",
        "guest_additions_mode": "disable",
        "headless": true,
        "format": "ova",
        "output_directory": "{{user `artifacts`}}/coreos-{{user `version`}}",
        "hard_drive_interface": "sata",
        "disk_size": 40000,
        "vboxmanage": [
            ["modifyvm", "{{.Name}}", "--cpus", "1"],
            ["modifyvm", "{{.Name}}", "--memory", "1024"]
        ],
        "iso_url": "http://downloads.sourceforge.net/project/systemrescuecd/sysresccd-x86/3.8.1/systemrescuecd-x86-3.8.1.iso?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fsystemrescuecd%2Ffiles%2Fsysresccd-x86%2F3.8.1%2Fsystemrescuecd-x86-3.8.1.iso%2Fdownload&ts=1396049223&use_mirror=softlayer-ams",
        "iso_checksum": "22acfc87b32d096290531d82feb87602",
        "iso_checksum_type": "md5",
        "ssh_username": "root",
        "ssh_password": "PackerInstaller",
        "boot_wait": "3s",
        "boot_command": [
            "<enter><wait5><enter>",
            "<wait10><wait5>",
            "echo 'root:PackerInstaller' | chpasswd<enter>"
        ],
        "shutdown_command": "shutdown -h now"
    }],
    "provisioners": [{
        "type": "shell",
        "only": ["amazon"],
        "inline": [
            "#!/bin/bash",
            "echo '>> Fixing sudo...'",
            "sudo sed -i -r -e 's|^(Defaults    secure_path.*)|\\1:/opt/aws/bin|g' /etc/sudoers",
            "echo '>> Prepping /tmp...'",
            "cd /tmp",
            "mkdir bundle",
            "echo '>> Downloading image...'",
            "wget http://storage.core-os.net/coreos/amd64-generic/{{user `version`}}/coreos_production_ami_image.bin.bz2 -O coreos.bin.bz2 || exit 1",
            "echo '>> Preparing image...'",
            "bunzip2 coreos.bin.bz2 || exit 1",
            "truncate --size 9G coreos.bin",
            "echo '>> Passing control to Packer...'"
        ]
    }, {
        "type": "file",
        "only": ["virtualbox"],
        "source": "id_rsa.pub",
        "destination": "/tmp/id_rsa.pub"
    }, {
        "type": "shell",
        "only": ["virtualbox"],
        "inline": [
            "#!/bin/sh",
            "wget https://raw.github.com/coreos/init/master/bin/coreos-install -O /tmp/coreos-install || exit 1",
            "bash /tmp/coreos-install -d /dev/sda -V {{user `version`}}",
            "mount /dev/sda9 /mnt/gentoo",
            "mkdir -p /mnt/gentoo/overlays/home/core/.ssh",
            "cp /tmp/id_rsa.pub /mnt/gentoo/overlays/home/core/.ssh/authorized_keys"
        ]
    }]
}
